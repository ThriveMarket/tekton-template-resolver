apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: standard-deployment-pipeline
spec:
  params:
    - name: app-name
      type: string
      description: The name of the application
    - name: git-url
      type: string
      description: The git repository URL
    - name: image-name
      type: string
      description: The container image name
    - name: environment
      type: string
      description: The deployment environment (dev or prod)
      default: dev
  tasks:
    - name: fetch-repository
      taskRef:
        name: git-clone
      params:
        - name: url
          value: $(params.git-url)
        - name: revision
          value: main
        - name: deleteExisting
          value: "true"
      workspaces:
        - name: output
          workspace: shared-workspace
    
    - name: build
      taskRef:
        name: kaniko
      runAfter:
        - fetch-repository
      params:
        - name: IMAGE
          value: $(params.image-name)
      workspaces:
        - name: source
          workspace: shared-workspace
    
    - name: deploy-to-dev
      taskRef:
        name: kubernetes-actions
      runAfter:
        - build
      when:
        - input: "$(params.environment)"
          operator: in
          values: ["dev"]
      params:
        - name: script
          value: |
            kubectl apply -f k8s/dev
            kubectl rollout status deployment/$(params.app-name) -n $(params.app-name)-dev
      workspaces:
        - name: manifest-dir
          workspace: shared-workspace
    
    # Custom post-dev deployment steps from template parameters
    {{- if .PostDevSteps}}
    # Start of user-defined post-dev steps
    {{.PostDevSteps}}
    # End of user-defined post-dev steps
    {{- else}}
    # Default post-dev steps when none provided
    - name: default-dev-validation
      taskSpec:
        steps:
        - name: echo
          image: alpine:3.15.1
          script: |
            echo "Running default post-dev validation..."
            echo "This step runs after dev deployment when no custom steps are provided."
    {{- end}}
    
    - name: deploy-to-prod
      taskRef:
        name: kubernetes-actions
      runAfter:
        - deploy-to-dev
      when:
        - input: "$(params.environment)"
          operator: in
          values: ["prod"]
      params:
        - name: script
          value: |
            kubectl apply -f k8s/prod
            kubectl rollout status deployment/$(params.app-name) -n $(params.app-name)-prod
      workspaces:
        - name: manifest-dir
          workspace: shared-workspace
    
    # Custom post-prod deployment steps from template parameters
    {{- if .PostProdSteps}}
    # Start of user-defined post-prod steps
    {{.PostProdSteps}}
    # End of user-defined post-prod steps
    {{- else}}
    # Default post-prod steps when none provided
    - name: default-prod-validation
      taskSpec:
        steps:
        - name: echo
          image: alpine:3.15.1
          script: |
            echo "Running default post-prod validation..."
            echo "This step runs after prod deployment when no custom steps are provided."
    {{- end}}
    
    - name: notify-slack
      taskRef:
        name: slack-notification
      runAfter:
        - deploy-to-dev
        - deploy-to-prod
      params:
        - name: message
          value: "Deployed $(params.app-name) to $(params.environment)"
        - name: channel
          value: "#deployments"
  
  workspaces:
    - name: shared-workspace